# app çš„å”¯ä¸€ id,ä¸Šæž¶åˆ°å•†åº—éœ€è¦ä¿è¯ä¸è¦å†²çª,å°½é‡ä½¿ç”¨å¼€å‘è€…è‡ªå·±çš„åŸŸåä½œä¸ºåŽç¼€.
package: cloud.lazycat.app.liu.agola
# app çš„ç‰ˆæœ¬
version: 0.11.0

name: Agola
keyword: agola,ci,cd,cicd,devops,continuous integration,continuous deployment,git,github,gitlab,gitea
description: Agola - CI/CD å¹³å°

# è½¯ä»¶åç§°,ä¼šæ˜¾ç¤ºåœ¨å¯åŠ¨å™¨ä¹‹ç±»çš„åœ°æ–¹
locales:
  zh:
    name: Agola
    description: |
      ## Agola - CI/CD é‡æ–°å®šä¹‰

      **å®˜æ–¹ç½‘ç«™:** https://agola.io
      **ä»“åº“åœ°å€:** https://github.com/lazycatapps/agola.git
      **å¿«é€Ÿå¼€å§‹:** https://github.com/lazycatapps/agola/blob/main/QUICKSTART.md

      Agola æ˜¯ä¸€ä¸ªçŽ°ä»£åŒ–çš„å¼€æº CI/CDï¼ˆæŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ï¼‰å¹³å°ï¼Œæ—¨åœ¨é‡æ–°å®šä¹‰æž„å»ºè‡ªåŠ¨åŒ–å·¥ä½œæµã€‚å®ƒæä¾›äº†å®¹å™¨åŒ–ã€å¯é‡çŽ°å’Œå¯é‡å¯çš„è¿è¡ŒçŽ¯å¢ƒï¼Œæ”¯æŒé«˜çº§å·¥ä½œæµç¨‹å’Œå¤šç§ Git å¹³å°é›†æˆã€‚

      ## ä¸»è¦åŠŸèƒ½

      - ðŸ³ **å®¹å™¨åŒ–æ‰§è¡Œ**: æ‰€æœ‰ä»»åŠ¡åœ¨éš”ç¦»çš„å®¹å™¨çŽ¯å¢ƒä¸­è¿è¡Œï¼Œç¡®ä¿å¯é‡çŽ°æ€§
      - ðŸ”„ **å¯é‡å¯è¿è¡Œ**: ä»Žå¤±è´¥ç‚¹æ¢å¤æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä»Žå¤´å¼€å§‹
      - ðŸŒ **å¤š Git å¹³å°æ”¯æŒ**: åŒæ—¶é›†æˆ GitHubã€GitLabã€Gitea å’Œè‡ªå®šä¹‰ Git ä»“åº“
      - ðŸš€ **é«˜çº§å·¥ä½œæµ**: æ”¯æŒçŸ©é˜µæž„å»ºã€æ‰‡å…¥æ‰‡å‡ºã€å¤šæž¶æž„ç­‰å¤æ‚å·¥ä½œæµ
      - â˜¸ï¸ **çµæ´»éƒ¨ç½²**: å¯åœ¨ Kubernetes é›†ç¾¤ã€æœ¬åœ° Docker ç­‰å¤šç§å¹³å°ä¸Šè¿è¡Œ
      - ðŸ“ **Jsonnet é…ç½®**: ä½¿ç”¨ Jsonnet æ¨¡æ¿ç”Ÿæˆé…ç½®ï¼Œé¿å…å¤æ‚çš„ YAML
      - ðŸ” **å¼ºå¤§çš„å¯†é’¥ç®¡ç†**: æ”¯æŒå¯†é’¥å’Œå˜é‡ç³»ç»Ÿï¼Œç”¨äºŽçŽ¯å¢ƒç‰¹å®šæµ‹è¯•
      - âš¡ **ä¾èµ–ç¼“å­˜**: åŠ é€Ÿä»»åŠ¡æ‰§è¡Œ
      - ðŸŽ¯ **ç”¨æˆ·ç›´æŽ¥è¿è¡Œ**: å…è®¸åœ¨æœ¬åœ°ä»“åº“ç›´æŽ¥æ‰§è¡Œæµ‹è¯•
      - ðŸ“Š **æ˜“äºŽå®‰è£…ç®¡ç†**: æ”¯æŒå•å®žä¾‹æˆ–åˆ†å¸ƒå¼éƒ¨ç½²

      ## ä½¿ç”¨æ–¹æ³•

      1. å¯åŠ¨åº”ç”¨åŽï¼Œé€šè¿‡åŸŸåè®¿é—® Agola Web ç•Œé¢
      2. è¿žæŽ¥ä½ çš„ Git å¹³å°è´¦å·ï¼ˆGitHub/GitLab/Giteaï¼‰ï¼Œé»˜è®¤ç®¡ç† token æ˜¯: admintoken
      3. åœ¨é¡¹ç›®ä¸­æ·»åŠ  `.agola/config.jsonnet` é…ç½®æ–‡ä»¶
      4. æŽ¨é€ä»£ç æˆ–åˆ›å»º Pull Request è§¦å‘è‡ªåŠ¨æž„å»º
      5. åœ¨ Web ç•Œé¢æŸ¥çœ‹è¿è¡ŒçŠ¶æ€å’Œæ—¥å¿—

      ## é…ç½®è¯´æ˜Ž

      é…ç½®æ–‡ä»¶ä½äºŽ `/lzcapp/var/config/config.yaml`ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š
      - API åœ°å€å’ŒåŸŸåé…ç½®
      - Git å¹³å°é›†æˆè®¾ç½®
      - æ‰§è¡Œå™¨é…ç½®
      - æ•°æ®å­˜å‚¨è·¯å¾„

      ## æ³¨æ„äº‹é¡¹

      - æœ¬åº”ç”¨å·²å¯ç”¨åŽå°ä»»åŠ¡ï¼Œç³»ç»Ÿä¸ä¼šè‡ªåŠ¨ä¼‘çœ 
      - é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„åŸŸåå ä½ç¬¦
      - æ•°æ®å­˜å‚¨åœ¨ `/lzcapp/var/agola` ç›®å½•ä¸‹
      - æ”¯æŒå¤šç”¨æˆ·åŒæ—¶ä½¿ç”¨

  en:
    name: Agola
    description: |
      ## Agola - CI/CD Redefined

      **Official Website:** https://agola.io

      **Repository:** https://github.com/lazycatapps/agola.git
      **Quickstart:** https://github.com/lazycatapps/agola/blob/main/QUICKSTART.md

      Agola is a modern open-source CI/CD (Continuous Integration/Continuous Deployment) platform designed to redefine build automation workflows. It provides containerized, reproducible, and restartable run environments, supporting advanced workflows and multiple Git platform integrations.

      ## Main Features

      - ðŸ³ **Containerized Execution**: All tasks run in isolated container environments, ensuring reproducibility
      - ðŸ”„ **Restartable Runs**: Resume execution from failure points instead of starting over
      - ðŸŒ **Multi-Git Platform Support**: Simultaneous integration with GitHub, GitLab, Gitea, and custom Git repositories
      - ðŸš€ **Advanced Workflows**: Support for matrix builds, fan-in/fan-out, multi-architecture, and other complex workflows
      - â˜¸ï¸ **Flexible Deployment**: Run on Kubernetes clusters, local Docker, and various platforms
      - ðŸ“ **Jsonnet Configuration**: Use Jsonnet templates to generate configurations, avoiding complex YAML
      - ðŸ” **Powerful Secrets Management**: Support for secrets and variables system for environment-specific testing
      - âš¡ **Dependency Caching**: Accelerate task execution
      - ðŸŽ¯ **User Direct Runs**: Enable testing directly in local repositories
      - ðŸ“Š **Easy Installation**: Support for single-instance or distributed deployments

      ## Usage Instructions

      1. After starting the application, access the Agola Web interface via the domain
      2. Connect your Git platform account (GitHub/GitLab/Gitea), the default admin token is: admintoken
      3. Add a `.agola/config.jsonnet` configuration file to your project
      4. Push code or create a Pull Request to trigger automatic builds
      5. View run status and logs in the Web interface

      ## Configuration

      Configuration file is located at `/lzcapp/var/config/config.yaml`, which can be modified as needed:
      - API address and domain configuration
      - Git platform integration settings
      - Executor configuration
      - Data storage paths

      ## Notes

      - This application has background tasks enabled, the system will not auto-sleep
      - First startup will automatically replace domain placeholders in the configuration file
      - Data is stored in the `/lzcapp/var/agola` directory
      - Supports multiple users simultaneously

# è½¯ä»¶æœ¬èº«çš„ license
license: https://choosealicense.com/licenses/apache-2.0/

# è½¯ä»¶çš„ä¸»é¡µ,ä¼šåœ¨å•†åº—ç­‰åœ°æ–¹ä½“çŽ°
homepage: https://github.com/agola-io/agola

# lpk çš„ä½œè€…,ä¼šåœ¨å•†åº—ç­‰åœ°æ–¹ä½“çŽ°
author: liu

# application ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ container è¿è¡Œï¼Œå¯¹åº”çš„ service åç§°ä¸ºå›ºå®šçš„`app`ï¼Œ å…¶ä»– service å¯ä»¥é€šè¿‡æ­¤åç§°ä¸Ž app è¿›è¡Œé€šè®¯
application:
  #æ˜¯å¦å­˜åœ¨åŽå°ä»»åŠ¡ï¼Œ è‹¥å­˜åœ¨åˆ™ç³»ç»Ÿä¸ä¼šå¯¹æ­¤ app è¿›è¡Œä¸»åŠ¨ä¼‘çœ ç­‰æ“ä½œ
  background_task: true

  # æœŸæœ›çš„ app åŸŸåï¼Œå¦‚æžœç³»ç»Ÿä¸­å·²ç»æœ‰å¯¹åº”åŸŸååˆ™ä¼šæç¤ºç”¨æˆ·é€‰æ‹©å…¶ä»–åŸŸåã€‚ æœ€ç»ˆ app åˆ†é…åˆ°çš„åŸŸåä»¥/lzcapp/run/app.subdomain ä¸ºå‡†
  subdomain: agola

  routes:
    - /=http://agola:8000

  depends_on:
    - agola

  # å¥åº·æ£€æµ‹ (å¼€å‘é˜¶æ®µå¯è®¾ disable)
  health_check:
    test_url: http://agola:8000             # HTTP URL æ£€æµ‹ (application ä¸“ç”¨)
    start_period: 30s                       # å¯åŠ¨ç­‰å¾…æ—¶é—´
    disable: false                          # ç¦ç”¨å¥åº·æ£€æµ‹

  public_path:
    - /                         # æ— éœ€ç™»å½•å³å¯è®¿é—®

  # # TCP/UDP æœåŠ¡é…ç½®
  # ingress:
  #   - protocol: tcp                       # åè®®ç±»åž‹ (tcp/udp)
  #     port: 4000                          # ç›®æ ‡ç«¯å£å· (ç•™ç©ºåˆ™ä½¿ç”¨å…¥ç«™ç«¯å£)
  #     service: agola                      # æœåŠ¡å®¹å™¨åç§° (ç•™ç©ºåˆ™ä¸º app)
  #     description: Run Server             # æœåŠ¡æè¿°
  #     publish_port: "4000"                # å…¥ç«™ç«¯å£å· (æ”¯æŒ "1000-50000" èŒƒå›´)
  #     send_port_info: false               # å‘é€ uint16 ç«¯å£ä¿¡æ¯ (little endian)
  #     yes_i_want_80_443: false            # å…è®¸ 80/443 æµé‡ (ç»•è¿‡ç³»ç»Ÿé‰´æƒ,æ…Žç”¨!)
  #   - protocol: tcp                       # åè®®ç±»åž‹ (tcp/udp)
  #     port: 4002                          # ç›®æ ‡ç«¯å£å· (ç•™ç©ºåˆ™ä½¿ç”¨å…¥ç«™ç«¯å£)
  #     service: agola                      # æœåŠ¡å®¹å™¨åç§° (ç•™ç©ºåˆ™ä¸º app)
  #     description: Config Store           # æœåŠ¡æè¿°
  #     publish_port: "4002"                # å…¥ç«™ç«¯å£å· (æ”¯æŒ "1000-50000" èŒƒå›´)
  #     send_port_info: false               # å‘é€ uint16 ç«¯å£ä¿¡æ¯ (little endian)
  #     yes_i_want_80_443: false            # å…è®¸ 80/443 æµé‡ (ç»•è¿‡ç³»ç»Ÿé‰´æƒ,æ…Žç”¨!)
  #   - protocol: tcp                       # åè®®ç±»åž‹ (tcp/udp)
  #     port: 4003                          # ç›®æ ‡ç«¯å£å· (ç•™ç©ºåˆ™ä½¿ç”¨å…¥ç«™ç«¯å£)
  #     service: agola                      # æœåŠ¡å®¹å™¨åç§° (ç•™ç©ºåˆ™ä¸º app)
  #     description: Git Server             # æœåŠ¡æè¿°
  #     publish_port: "4003"                # å…¥ç«™ç«¯å£å· (æ”¯æŒ "1000-50000" èŒƒå›´)
  #     send_port_info: false               # å‘é€ uint16 ç«¯å£ä¿¡æ¯ (little endian)
  #     yes_i_want_80_443: false            # å…è®¸ 80/443 æµé‡ (ç»•è¿‡ç³»ç»Ÿé‰´æƒ,æ…Žç”¨!)

  # æ˜¯å¦å¯ç”¨å¤šå®žä¾‹
  multi_instance: false

  gpu_accel: false
  kvm_accel: false
  usb_accel: false

services:
  agola:
    # lzc-cli appstore copy-image sorintlab/agolademo
    image: registry.lazycat.cloud/liu/sorintlab/agolademo:4980eb70b59d050e
    # command: serve --components all-base,executor
    setup_script: |
      #!/bin/sh
      set -eu
      CONFIG_DIR="/config"
      DEFAULT_DIR="/lzcapp/pkg/content/config"
      VERSION_FILE="${CONFIG_DIR}/.agola_version"
      CURRENT_VERSION="v0.11.0"
      INSTALLED_VERSION=""

      if [ -f "${VERSION_FILE}" ]; then
        INSTALLED_VERSION=$(cat "${VERSION_FILE}")
        echo "Detected installed version: ${INSTALLED_VERSION}"
      fi

      if [ -n "${INSTALLED_VERSION}" ] && [ "${INSTALLED_VERSION}" != "${CURRENT_VERSION}" ]; then
        echo "Configuration upgrade detected from ${INSTALLED_VERSION} to ${CURRENT_VERSION}"
      fi

      if [ ! -f "${CONFIG_DIR}/config.yaml" ] && [ -f "${DEFAULT_DIR}/config.yaml" ]; then
        cp -f "${DEFAULT_DIR}/config.yaml" "${CONFIG_DIR}/config.yaml"
        echo "Initialized config.yaml from defaults"
      fi

      # Replace the host placeholders in config.yaml
      sed -i -e "s|https\?://localhost:8000|https://${LAZYCAT_APP_DOMAIN}|g" \
             -e "s|https://[^\"]*\.heiyu\.space|https://${LAZYCAT_APP_DOMAIN}|g" /config/config.yaml

      # Save current version
      echo "$CURRENT_VERSION" > "$VERSION_FILE"

      echo "Creating data directories..."
      mkdir -p /data/agola/notification
      mkdir -p /data/agola/configstore/ost
      mkdir -p /data/agola/runservice/ost
      mkdir -p /data/agola/executor
      mkdir -p /data/agola/gitserver

      echo "Starting Agola server..."
      agola serve --components all-base,executor --config /config/config.yaml
    binds:
      - /lzcapp/var/config:/config
      - /lzcapp/var/agola:/data/agola

unsupported_platforms:
  - ios
  - android
  - tvos
